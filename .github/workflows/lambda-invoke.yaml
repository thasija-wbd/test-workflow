name: Persist Job Definitions
on:
  push:
    branches:
      - main
    paths:
      - job-definitions/**
permissions: write-all
jobs:
  checkout:
    runs-on: ubuntu-latest
    outputs:
      added_count: ${{steps.files-count.outputs.added_files_count}}
      modified_count: ${{steps.files-count.outputs.modified_files_count}}
      added_json: ${{steps.files-list.outputs.added_files}}
      modified_json: ${{steps.files-list.outputs.modified_files}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: job-definitions/**
      - name: List all added files
        run: |
          for file in ${{steps.changed-files.outputs.added_files}}; do
          echo "$file was added"
          done
          for file in ${{ steps.changed-files.outputs.modified_files }}; do
          echo "$file was modified"
          done
      - id: files-count
        run: |
          echo "added_files_count=${{ steps.changed-files.outputs.added_files_count }}" >> $GITHUB_OUTPUT
          echo "modified_files_count=${{ steps.changed-files.outputs.modified_files_count }}" >> $GITHUB_OUTPUT
      - id: files-list
        run: |
          echo "added_files= $( "${{ steps.changed-files.outputs.added_files }}" | jq -R -s -c 'split("\n")[:-1]')" >> "$GITHUB_OUTPUT"
          echo "modified_files=$( "${{ steps.changed-files.outputs.modified_files }}" | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT
  add-action:
    if: ${{ needs.checkout.outputs.added_count > 0 }}
    needs:
      - checkout
    strategy:
      matrix:
        added: ${{fromJson(needs.checkout.outputs.added_json)}}
    uses: ./.github/workflows/persist-job.yaml
    with:
      file: ${{ matrix.added }}
      action: "CREATE"
      account-id: 727224480698
  modify-action:
    if: ${{ needs.checkout.outputs.modified_count > 0 }}
    needs:
      - checkout
    strategy:
      matrix:
        modified: ${{fromJson(needs.checkout.outputs.modified_json)}}
    uses: ./.github/workflows/persist-job.yaml
    with:
      file: ${{ matrix.modified }}
      action: "UPDATE"
      account-id: 727224480698
