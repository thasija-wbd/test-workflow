name: convert-yaml-to-json

on:
  push:
    branches:
      - main
    paths:
      - "job-definitions/**"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2 # Ensure the entire Git history is available

      - name: Install dependencies
        run: |
          sudo add-apt-repository ppa:rmescandon/yq -y
          sudo apt-get update
          sudo apt-get install yq -y
          sudo apt-get install jq

      - name: Detect changed YAML files
        id: detect-changed-yaml
        run: |
          CHANGED_YAML=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} -- job-definitions/**)
          CHANGED_YAML_COUNT=$(echo "$CHANGED_YAML" | wc -l)
          echo "Changed YAML files: $CHANGED_YAML_COUNT"
          echo "changed yaml : $CHANGED_YAML"
          concatenated_lines=""
          for ((i=1; i<=CHANGED_YAML_COUNT; i++)); do
            line=$(echo "$CHANGED_YAML" | sed -n "${i}p")
            YAML_CONTENT=$(cat "$line")
            concatenated_lines="${concatenated_lines}${YAML_CONTENT} -------"
            echo "${concatenated_lines}"
          done
          echo "BEFORE OPERATION ${concatenated_lines}"
          concatenated_lines="${concatenated_lines% -------}"
          echo "Concatenated lines $concatenated_lines"
          echo "::set-output name=changed_yaml::${{toJSON(concatenated_lines)}}"

      - name: calling custom-action-to-test
        uses: thasija-wbd/test-custom-action@v0.0.2
        with:
          yaml_files: ${{steps.detect-changed-yaml.outputs.changed_yaml}}
